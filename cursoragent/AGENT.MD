# CursorAgent – دستورالعمل کلی پروژه Diabetes Pilot (ادامهٔ Helssa)

> یادداشت: پوشه‌ی مستندات فازبه‌فاز (`/doc/phaseX/`) در این ریپو حاضر ممکن است کامل یا حاضر نباشد. در صورت نبود فایل‌های `should-*` یک فاز، فقط در محدوده‌ی همین ریپو و تست‌ها عمل کنید و از ایجاد ساختارهای جدید خارج از دامنه خودداری کنید. هر جا ابهامی بود، طبق «مدیریت مغایرت/تناقض» عمل کنید.

> **این فایل مرجع واحد همهٔ ایجنت‌هاست.** فقط طبق این دستورالعمل و پوشهٔ `/docs` عمل کنید. هیچ ابتکار شخصی خارج از اسناد مجاز نیست. این پروژه ادامهٔ **Helssa** است.

---

## 0) اصول قطعی

* **منبع واحد**: فقط محتوای `/docs` + فایل‌های `should-*` هر فاز. فایل‌های `suggestion-*` صرفاً راهنماست؛ اگر با `should-*` تعارض داشت، `should-*` ارجح است.
* **Prompt-Driven**: فاز فعال، اسامی فایل‌ها و محدودهٔ کار در **پرامپت اصلی** مشخص می‌شود. فقط همان فاز را اجرا کنید.
* **عدم تغییر URL مرکزی**: تنظیمات و مسیرها را **در داخل همان پروژه/فاز** اعمال کنید. به URL/Router مرکزی خارج از محدوده دست نزنید.
* **عدم خلق ساختار جدید**: فقط فایل‌ها/پوشه‌های تعریف‌شده را بسازید. نام‌گذاری طبق اسناد.
* **توقف در تناقض**: هر مغایرت/ابهام/تعارض → **فوراً تولید قطع**، سؤال حداقلی ثبت، و گزارش در `cursoragent/PARADOX_REPORT.md`.
* **بدون کپی کد از منابع بیرونی**: هر کد باید از `should-*` و اسناد `/docs` مشتق شود.

---

## 1) جریان کار استاندارد هر فاز

1. **دریافت پرامپت** (فاز و دامنه مشخص می‌شود).
2. **Checkout** برنچ اختصاصی فاز: `git checkout -b feat/<phase-code>-<slug>`
3. **ایجاد فایل‌های الزامی فاز**:

   * `should-coding-code.md` → پیاده‌سازی کامل کدها
   * `should-phase-architecture.md` → معماری همان فاز داخل پوشهٔ فاز
   * `should-test-coding-code.md` → تست‌های اجباری
   * `should-instructions.md` → دستورالعمل اجرایی
   * سایر فایل‌ها طبق ساختار فاز
4. **پیاده‌سازی دقیق**: فقط دستورات موجود را اجرا کنید. اگر دستور نبود، از `suggestion-*` همان فاز استفاده کنید.
5. **اجرای تست‌ها**: فقط تست‌های همان فاز. لاگ تست را ذخیره کنید: `logs/<phase-code>/test-report.txt`.
6. **لاگ‌گذاری توسعه**: دستورات و خروجی‌های کلیدی را در `logs/<phase-code>/build-log.txt` ذخیره کنید.
7. **Commit & PR**:

   * پیام کامیت: `<phase-code>: <short-desc>` (مثال: `phase-04: api viewsets + jwt`)
   * PR به `develop` با لیبل‌های فاز (مثال: `phase-04`, `api`, `cursor-agent`)

---

## 2) ساختار برنچ‌ها و کار موازی

* **هشت ایجنت** به‌صورت موازی روی فازهای تعریف‌شده کار می‌کنند.
* ایجاد برنچ موازی برای هر ایجنت بر اساس پرامپت اصلی (نمونه):

  * `feat/phase-01-setup`
  * `feat/phase-02-models`
  * `feat/phase-03-versioning`
  * `feat/phase-04-api`
  * `feat/phase-05-ai`
  * `feat/phase-06-references`
  * `feat/phase-07-security`
  * `feat/phase-08-testflow`
* تداخل‌ها و تعارض‌ها باید در PR حل شوند. تغییر در فایل‌های فاز دیگر **ممنوع** مگر با پرامپت جدید.

---

## 3) قوانین کدنویسی و تست

* Python 3.11, Django 5, DRF, Celery, Redis, Postgres, MinIO.
* قالب‌دهی: Black + isort.
* پوشش تست: اجرای `pytest -q` در فاز مربوطه.
* هر تستِ الزامی باید سبز باشد. تست شکست‌خورده → تولید متوقف و گزارش.
* لاگ تست و بیلد:

  * `logs/<phase>/test-report.txt`
  * `logs/<phase>/build-log.txt`

---

## 4) تنظیمات پروژه (درون پروژه)

* تمام تنظیمات هر فاز **داخل همان پروژه/فاز** انجام شود.
* از ویرایش یا وابستگی به URL/Router مرکزی خارج از محدوده خودداری کنید.
* متغیرهای محیطی را در `.env` همان پروژه تعریف کنید.

---

## 5) مدیریت مغایرت/تناقض

* در صورت مشاهدهٔ هر نوع تناقض (میان `should-*` و کد موجود، یا بین پرامپت و اسناد):

  1. **توقف تولید**.
  2. ایجاد فایل `cursoragent/PARADOX_REPORT.md` با قالب:

     * عنوان فاز و فایل/بخش متناقض
     * شرح مختصر تناقض
     * پیوند به منبع (`/docs` یا `should-*`)
     * سؤال/درخواست تصمیم
  3. هیچ اصلاحی انجام ندهید تا پاسخ دریافت شود.

---

## 6) منابع مجاز

* `/docs` و فایل‌های `should-*` در هر فاز.
* `suggestion-*` فقط در نبود دستور معین.
* **منابع بیرونی ممنوع**.

---

## 7) نقش دو Agent بازبین (Gemini & CodeRabbit)

* **Scope**: High-level Summary, Review, Defect Finding بر تمام شاخه‌ها.
* **وظایف**:

  * تهیهٔ خلاصهٔ High-Level برای هر PR در `reviews/<phase>/summary.md`.
  * گزارش اشکالات و ریسک‌ها در `reviews/<phase>/issues.md`.
  * بررسی انطباق با Helssa (این پروژه ادامهٔ Helssa است): چک‌لیست `reviews/<phase>/helssa-compat.md`.
* **محدودیت**: تغییر کد ممنوع؛ فقط کامنت/فایل‌های review.

---

## 8) خروجی‌های اجباری پس از هر فاز

* `logs/<phase>/build-log.txt`
* `logs/<phase>/test-report.txt`
* (در صورت وجود بازبینی) `reviews/<phase>/*`
* PR به `develop` با لیبل‌های فاز

---

## 9) چک‌لیست تحویل فاز

* [ ] فایل‌های `should-*` تکمیل
* [ ] تست‌های اجباری سبز
* [ ] لاگ‌ها در مسیر `logs/<phase>/`
* [ ] مستندات Review (در صورت درخواست) کامل
* [ ] بدون تغییرات خارج از محدودهٔ فاز
* [ ] PR با لیبل‌های درست

---

## 10) الگوی پیام‌ها و نام‌ها

* **Commit**: `phase-XX: <desc>`
* **Branch**: `feat/phase-XX-<slug>`
* **PR Labels**: `phase-XX`, `<topic>`, `cursor-agent`

---

## 11) اجرای دقیق دستورات پرامپت

* اگر دستوری در پرامپت اصلی وجود دارد، **حتماً** اجرا شود.
* اگر دستور مبهم/متناقض است → بند «مدیریت مغایرت/تناقض».

---

## 12) قواعد توقف تولید

* تناقض، ابهام، یا شکست تست‌های اجباری → توقف فوری.
* ثبت گزارش در `cursoragent/PARADOX_REPORT.md` و درخواست راهنمایی.

---

## 13) نمونهٔ لاگ‌گذاری

```
mkdir -p logs/phase-04
pytest -q > logs/phase-04/test-report.txt 2>&1
python manage.py check > logs/phase-04/build-log.txt 2>&1
```

---

## 14) امنیت و داده

* کلیدها فقط در `.env` فاز.
* دادهٔ حساس نمونه‌سازی شود؛ دادهٔ واقعی بارگذاری نشود.

---

## 15) نتیجه‌گیری

* فقط طبق این سند و `/docs` عمل کنید.
* این پروژه ادامهٔ Helssa است؛ سازگاری حفظ شود.
* هر فاز مستقل و ایزوله تحویل شود؛ ادغام در PR.